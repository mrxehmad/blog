<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>How to Fix Intermittent SSL Errors in Local Networks When Using Cloudflare Tunnels Not Working :/  - Ehmi</title><meta name="description" content="Ehmi – your go-to resource for tackling Linux issues, solving technical roadblocks, and enhancing your experience with open-source tools."><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://blog.ehmad.site/how-to-fix-intermittent-ssl-errors-in-local-networks-when-using-cloudflare-tunnels/"><link rel="alternate" type="application/atom+xml" href="https://blog.ehmad.site/feed.xml" title="Ehmi - RSS"><link rel="alternate" type="application/json" href="https://blog.ehmad.site/feed.json" title="Ehmi - JSON"><meta property="og:title" content="How to Fix Intermittent SSL Errors in Local Networks When Using Cloudflare Tunnels Not Working :/ "><meta property="og:image" content="https://blog.ehmad.site/media/website/ehmi.png"><meta property="og:image:width" content="150"><meta property="og:image:height" content="100"><meta property="og:site_name" content="Ehmi"><meta property="og:description" content="Ehmi – your go-to resource for tackling Linux issues, solving technical roadblocks, and enhancing your experience with open-source tools."><meta property="og:url" content="https://blog.ehmad.site/how-to-fix-intermittent-ssl-errors-in-local-networks-when-using-cloudflare-tunnels/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://blog.ehmad.site/media/website/ehmi_e.png" type="image/x-icon"><link rel="stylesheet" href="https://blog.ehmad.site/assets/css/style.css?v=d385bc0ff3a04c1b92f998df1d9dfc3f"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.ehmad.site/how-to-fix-intermittent-ssl-errors-in-local-networks-when-using-cloudflare-tunnels/"},"headline":"How to Fix Intermittent SSL Errors in Local Networks When Using Cloudflare Tunnels Not Working :/ ","datePublished":"2025-03-08T17:57+05:00","dateModified":"2025-03-09T16:48+05:00","image":{"@type":"ImageObject","url":"https://blog.ehmad.site/media/website/ehmi.png","height":100,"width":150},"description":"Ehmi – your go-to resource for tackling Linux issues, solving technical roadblocks, and enhancing your experience with open-source tools.","author":{"@type":"Person","name":"Ehmad","url":"https://blog.ehmad.site/authors/ehmad/"},"publisher":{"@type":"Organization","name":"Ehmad","logo":{"@type":"ImageObject","url":"https://blog.ehmad.site/media/website/ehmi.png","height":100,"width":150}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://blog.ehmad.site/"><img src="https://blog.ehmad.site/media/website/ehmi.png" alt="Ehmi" width="150" height="100"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://blog.ehmad.site/about-ehmi/" target="_self">About me</a></li><li><a href="https://blog.ehmad.site/contact-us/" target="_self">Contact</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="wrapper search__overlay-inner"></div></div><button class="search__btn btn--icon js-search-btn" aria-label="Search"><svg height="18" width="18" role="presentation" focusable="false"><use xlink:href="https://blog.ehmad.site/assets/svg/svg-map.svg#search"/></svg></button></div></header><main class="post"><article class="content"><div class="hero hero--noimage"><header class="hero__content"><div class="wrapper"><h1>How to Fix Intermittent SSL Errors in Local Networks When Using Cloudflare Tunnels Not Working :/ </h1><div class="feed__meta content__meta"><a href="https://blog.ehmad.site/authors/ehmad/" class="feed__author">Ehmad</a> <time datetime="2025-03-08T17:57" class="feed__date">March 8, 2025</time></div></div></header></div><div class="entry-wrapper content__entry"><p>If you’re hosting a service on your local network and using Cloudflare tunnels for external access, you might encounter intermittent SSL errors like <code>ssl_error_unrecognized_name_alert</code> when accessing your site locally. This issue arises due to DNS resolution inconsistencies or certificate mismatches between your local server and Cloudflare’s CDN. In this article, we’ll explore the root cause of the problem and provide a comprehensive solution. This journey made me cry fr.</p><hr><h2 id="the-problem-why-does-this-happen"><strong>The Problem: Why Does This Happen?</strong></h2><p>When you host a service (e.g., a website) on your local network and use Cloudflare tunnels for external access, there are two distinct paths for traffic:</p><ol><li><p><strong>Local Network Traffic</strong>:</p><ul><li>Clients within the local network should resolve the domain (e.g., <code>pihole.example.com</code>) to the internal IP address of your server (e.g., <code>192.168.1.100</code>).</li><li>The local server serves an SSL certificate issued by Let’s Encrypt for <code>*.example.com</code>.</li></ul></li><li><p><strong>External Network Traffic</strong>:</p><ul><li>Clients outside the local network resolve the domain to Cloudflare’s external IP (e.g., <code>104.x.x.x</code>).</li><li>Cloudflare serves its own SSL certificate for <code>example.com</code>.</li></ul></li></ol><h3 id="why-do-ssl-errors-occur-locally"><strong>Why Do SSL Errors Occur Locally?</strong></h3><ul><li><strong>DNS Resolution Fluctuations</strong>: If your local DNS resolver (e.g., Pi-hole) intermittently resolves the domain to the external IP instead of the internal IP, the request routes through Cloudflare. Cloudflare’s certificate does not match the subdomain (<code>pihole.example.com</code>), causing an SSL error.</li><li><strong>SNI Misconfiguration</strong>: Some clients or devices may not send the correct Server Name Indication (SNI) header, leading the server to default to an incorrect certificate.</li></ul><hr><h2 id="solution-how-to-fix-the-issue"><strong>Solution: How to Fix the Issue</strong></h2><p>To resolve the problem, you need to ensure consistent DNS resolution and proper SSL certificate handling for local clients. Follow these steps:</p><hr><h3 id="step-1-configure-split-horizon-dns-in-pi-hole"><strong>Step 1: Configure Split-Horizon DNS in Pi-hole</strong></h3><p>Split-horizon DNS ensures that local clients resolve the domain to the internal IP address while external clients resolve it to the external IP.</p><ol><li><p><strong>Add Local DNS Records</strong>:</p><ul><li>Go to <strong>Pi-hole &gt; Local DNS &gt; DNS Records</strong>.</li><li>Add a wildcard entry for your domain:<pre><code>Domain: *.example.com
IP: 192.168.1.100
</code></pre></li><li>Save the configuration.</li></ul></li><li><p><strong>Disable Upstream Forwarding</strong>:</p><ul><li>Navigate to <strong>Pi-hole &gt; Settings &gt; DNS</strong>.</li><li>Under <strong>“Never forward the following domains”</strong>, add:<pre><code>example.com
</code></pre></li><li>Save the settings to prevent Pi-hole from querying external DNS servers for this domain.</li></ul></li></ol><hr><h3 id="step-2-verify-web-server-configuration"><strong>Step 2: Verify Web Server Configuration</strong></h3><p>Ensure your web server (e.g., Nginx or Apache) is properly configured to handle requests for the subdomain (<code>pihole.example.com</code>).</p><h4 id="for-nginx"><strong>For Nginx</strong>:</h4><pre><code class="language-nginx">server {
    listen 443 ssl;
    server_name pihole.example.com;

    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    # Other SSL settings...
}
</code></pre><h4 id="for-apache"><strong>For Apache</strong>:</h4><pre><code class="language-apache">&lt;VirtualHost *:443&gt;
    ServerName pihole.example.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem

    # Other SSL settings...
&lt;/VirtualHost&gt;
</code></pre><hr><h3 id="step-3-test-dns-resolution"><strong>Step 3: Test DNS Resolution</strong></h3><p>After configuring Pi-hole, verify that the domain resolves correctly to the internal IP:</p><pre><code class="language-bash">nslookup pihole.example.com 192.168.1.100
</code></pre><p>The output should return:</p><pre><code>Address: 192.168.1.100
</code></pre><p>If it returns the external IP (e.g., <code>104.21.50.106</code>), revisit your Pi-hole configuration to ensure split-horizon DNS is working as expected.</p><hr><h3 id="step-4-clear-client-side-caches"><strong>Step 4: Clear Client-Side Caches</strong></h3><p>Sometimes, old DNS records or browser caches can cause issues. Clear them as follows:</p><h4 id="clear-dns-cache"><strong>Clear DNS Cache</strong>:</h4><pre><code class="language-bash"># Windows
ipconfig /flushdns

# Linux/macOS
sudo systemd-resolve --flush-caches
</code></pre><h4 id="clear-browser-cache"><strong>Clear Browser Cache</strong>:</h4><p>Use incognito mode or manually clear your browser’s cache.</p><hr><h3 id="step-5-test-ssl-handshake"><strong>Step 5: Test SSL Handshake</strong></h3><p>Finally, test the SSL handshake to confirm that the correct certificate is being served:</p><pre><code class="language-bash">openssl s_client -connect 192.168.1.100:443 -servername pihole.example.com
</code></pre><p>Look for the following in the output:</p><ul><li><strong>Subject</strong>: <code>CN = *.example.com</code></li><li><strong>Issuer</strong>: <code>C = US, O = Let&#39;s Encrypt, CN = E6</code></li></ul><p>If the certificate matches, your setup is correct.</p><hr><p>Yes, that’s correct! If you’re using Cloudflare for external access and also want to serve your domains locally within your network, it’s important to ensure that <strong>all domains managed by Cloudflare</strong> (including the main domain and its subdomains) are properly forwarded to your local server and have valid SSL certificates issued by Let’s Encrypt. This ensures consistent behavior for both local and external traffic.</p><p>Here’s a detailed explanation of why this is necessary and how to implement it:</p><hr><h2 id="why-should-all-domains-managed-by-cloudflare-be-forwarded-locally"><strong>Why Should All Domains Managed by Cloudflare Be Forwarded Locally?</strong></h2><ol><li><p><strong>Consistent DNS Resolution</strong>:</p><ul><li>When a domain or subdomain is managed by Cloudflare, external clients resolve it to Cloudflare’s IP addresses. However, local clients should resolve it to your internal server’s IP address (e.g., <code>192.168.1.100</code>).</li><li>Without proper local DNS forwarding, local clients might inadvertently resolve the domain to Cloudflare’s external IP, causing SSL mismatches or routing issues.</li></ul></li><li><p><strong>Avoid Certificate Mismatches</strong>:</p><ul><li>Cloudflare serves its own SSL certificate for domains it manages. If a local client resolves a domain to Cloudflare’s external IP, the certificate presented will not match the local server’s configuration.</li><li>By forwarding all domains locally and using Let’s Encrypt certificates on your local server, you ensure that local clients always receive the correct certificate.</li></ul></li><li><p><strong>Performance and Reliability</strong>:</p><ul><li>Routing local traffic through Cloudflare introduces unnecessary latency and dependency on external services. By resolving domains locally, you improve performance and reduce reliance on external infrastructure.</li></ul></li></ol><hr><h2 id="forward-main-domain-and-sub-domain-locally-and-secure-them-with-lets-encrypt"><strong>Forward Main Domain and Sub Domain Locally and Secure Them with Let’s Encrypt</strong></h2><h3 id="step-1-add-local-dns-records-for-all-domains"><strong>Step 1: Add Local DNS Records for All Domains</strong></h3><p>In Pi-hole, configure split-horizon DNS to ensure all domains and subdomains resolve to your local server’s IP address.</p><ol><li><p>Go to <strong>Pi-hole &gt; Local DNS &gt; DNS Records</strong>.</p></li><li><p>Add entries for your main domain and subdomains:</p><pre><code>Domain: example.com
IP: 192.168.1.100

Domain: *.example.com
IP: 192.168.1.100
</code></pre><ul><li>The wildcard entry (<code>*.example.com</code>) ensures that all subdomains (e.g., <code>pihole.example.com</code>, <code>www.example.com</code>) resolve locally.(pihle local dns doens’t support wildcards. You have to add each domain manually )</li></ul></li><li><p>Save the configuration.</p></li></ol><hr><h3 id="step-2-disable-upstream-forwarding-for-all-domains-optional"><strong>Step 2: Disable Upstream Forwarding for All Domains (Optional)</strong></h3><p>Prevent Pi-hole from querying external DNS servers for your domains.</p><ol><li>Navigate to <strong>Pi-hole &gt; Domains</strong>.</li><li>Under <strong>“Add Wildcard Regex blocklist”</strong>, add:<pre><code>*.example.com
</code></pre></li><li>Save the settings.</li></ol><hr><h3 id="step-3-obtain-lets-encrypt-certificates-for-all-domains-google-it-if-you-dont-have"><strong>Step 3: Obtain Let’s Encrypt Certificates for All Domains (Google it if you don’t have)</strong></h3><h3 id="step-4-test-your-configuration"><strong>Step 4: Test Your Configuration</strong></h3><p>After setting up DNS and SSL, test the following:</p><ol><li><p><strong>DNS Resolution</strong>:</p><pre><code class="language-bash">nslookup example.com 192.168.1.100
nslookup pihole.example.com 192.168.1.100
</code></pre><ul><li>Both should return <code>192.168.1.100</code>.</li></ul></li><li><p><strong>SSL Handshake</strong>:</p><pre><code class="language-bash">openssl s_client -connect 192.168.1.100:443 -servername pihole.example.com
</code></pre><ul><li>Verify that the certificate matches <code>*.example.com</code>.</li></ul></li><li><p><strong>Browser Access</strong>:</p><ul><li>Open <code>https://pihole.example.com</code> in a browser and confirm that the site loads without SSL errors.</li></ul></li></ol><hr><h2 id="key-points-to-remember"><strong>Key Points to Remember</strong></h2><ol><li><p><strong>All Domains Must Resolve Locally</strong>:</p><ul><li>Ensure that both the main domain (<code>example.com</code>) and all subdomains resolve to your local server’s IP address.</li></ul></li><li><p><strong>Use Let’s Encrypt for Local SSL</strong>:</p><ul><li>Let’s Encrypt certificates are free, widely trusted, and easy to renew. They ensure that local clients receive valid SSL certificates.</li></ul></li><li><p><strong>Avoid External Dependencies</strong>:</p><ul><li>By resolving domains locally, you eliminate the need for local traffic to pass through Cloudflare, improving performance and reliability.</li></ul></li><li><p><strong>Monitor Logs</strong>:</p><ul><li>Regularly check your web server logs and Pi-hole logs to ensure everything is functioning as expected.</li></ul></li></ol><hr><h2 id="conclusion"><strong>Conclusion</strong></h2><p>When using Cloudflare for external access, it’s crucial to configure your local network to handle all domains and subdomains internally. By forwarding all domains to your local server, disabling upstream DNS forwarding, and securing them with Let’s Encrypt certificates, you can ensure seamless and secure access for both local and external clients.</p><p>This approach eliminates intermittent SSL errors, improves performance, and provides a consistent user experience across your network. If you follow these steps, your setup will be robust and reliable for all users.</p></div><footer class="content__footer"><div class="entry-wrapper"><p class="content__updated">This article was updated on March 9, 2025</p><div class="content__actions"><div class="content__share"><button class="btn--icon content__share-button js-content__share-button"><svg width="20" height="20" aria-hidden="true"><use xlink:href="https://blog.ehmad.site/assets/svg/svg-map.svg#share"></use></svg> <span>Share It</span></button><div class="content__share-popup js-content__share-popup"></div></div></div><div class="content__bio bio"><div><h3 class="h4 bio__name"><a href="https://blog.ehmad.site/authors/ehmad/" rel="author">Ehmad</a></h3></div></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://blog.ehmad.site/fixing-pushrejectederror-in-publii-cms-while-syncing-with-github/" class="content__nav-link" rel="prev"><div><span>Previous</span> Fixing PushRejectedError in Publii CMS While Syncing with GitHub</div></a></div><div class="content__nav-next"><a href="https://blog.ehmad.site/follow-up-solution-for-ssl-error-err_ssl_unrecognized_name_alert-in-local/" class="content__nav-link" rel="next"><div><span>Next</span> Follow-Up: Solution for SSL Error &quot;ERR_SSL_UNRECOGNIZED_NAME_ALERT&quot; in Local</div></a></div></div></div></nav></footer></article><div class="content__related related"><div class="wrapper"><h2 class="h4 related__title">You should also read:</h2><article class="feed__item feed__item--centered"><div class="feed__content"><header><div class="feed__meta"><a href="https://blog.ehmad.site/authors/ehmad/" class="feed__author">Ehmad</a> <time datetime="2025-03-09T16:47" class="feed__date">March 9, 2025</time></div><h3 class="feed__title"><a href="https://blog.ehmad.site/follow-up-solution-for-ssl-error-err_ssl_unrecognized_name_alert-in-local/">Follow-Up: Solution for SSL Error &quot;ERR_SSL_UNRECOGNIZED_NAME_ALERT&quot; in Local</a></h3></header><p>SSL Error “ERR_SSL_UNRECOGNIZED_NAME_ALERT” in Local Networks Using Cloudflare Tunnels In a previous article, I discussed the issue of intermittent SSL error “ERR_SSL_UNRECOGNIZED_NAME_ALERT” when using Cloudflare tunnels in local networks and explored possible solutions. However, the methods suggested did not completely resolve the issue. Thanks to&hellip;</p><a href="https://blog.ehmad.site/follow-up-solution-for-ssl-error-err_ssl_unrecognized_name_alert-in-local/" class="readmore feed__readmore">Continue reading...</a></div></article><article class="feed__item feed__item--centered"><div class="feed__content"><header><div class="feed__meta"><a href="https://blog.ehmad.site/authors/ehmad/" class="feed__author">Ehmad</a> <time datetime="2025-01-08T19:14" class="feed__date">January 8, 2025</time></div><h3 class="feed__title"><a href="https://blog.ehmad.site/data-communications-and-networking-5th-edition/">Data Communications and Networking 5th edition</a></h3></header><p>Chapter 18: Introduction to Network Layer in Data Communications and Networking (5th edition) by Behrouz A. Forouzan: The network layer plays a critical role in delivering data between devices over interconnected networks. It provides the following key services: Packet switching is a fundamental method for&hellip;</p><a href="https://blog.ehmad.site/data-communications-and-networking-5th-edition/" class="readmore feed__readmore">Continue reading...</a></div></article><article class="feed__item feed__item--centered"><div class="feed__content"><header><div class="feed__meta"><a href="https://blog.ehmad.site/authors/ehmad/" class="feed__author">Ehmad</a> <time datetime="2025-01-05T11:01" class="feed__date">January 5, 2025</time></div><h3 class="feed__title"><a href="https://blog.ehmad.site/remove-apps-using-adb-android-debug-bridge/">Remove apps using ADB (Android Debug Bridge)</a></h3></header><p>You can remove apps using ADB (Android Debug Bridge) by following these steps: Connect Your Device: Verify ADB Connection: adb devices If prompted on your device, grant USB debugging permission. The terminal should display your device’s serial number, confirming the connection. List Installed Apps: adb&hellip;</p><a href="https://blog.ehmad.site/remove-apps-using-adb-android-debug-bridge/" class="readmore feed__readmore">Continue reading...</a></div></article></div></div></main><footer class="footer footer--glued"><div class="wrapper"><nav class="footer__nav"><ul><li><a href="https://blog.ehmad.site/terms-and-conditions-for-ehmi/" class="al" target="_self">Terms and Conditions</a></li><li><a href="https://blog.ehmad.site/privacy-policy-for-ehmi/" class="al" target="_self">Privacy Policy</a></li><li><a href="https://blog.ehmad.site/contact-us/" class="al" target="_self">Contact</a></li><li><a href="https://github.com/mrxehmad/" class="al" target="_blank">Github</a></li></ul></nav><div class="footer__copyright"><p>Copyright 2025</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://blog.ehmad.site/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://blog.ehmad.site/assets/js/scripts.min.js?v=700105c316933a8202041b6415abb233"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner pcb__banner--right"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://blog.ehmad.site/privacy-policy-for-ehmi/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies. <a href="https://blog.ehmad.site/privacy-policy-for-ehmi/">More details...</a></div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>